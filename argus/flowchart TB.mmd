flowchart TB
    %% ============ EXTERNAL SOURCES ============
    WA["üì± WhatsApp Messages"]
    CHROME["üåê Chrome Browser"]

    %% ============ EVOLUTION API ============
    subgraph EVOL ["‚ö° Evolution API :8080"]
        direction LR
        EVOL_SVC["Evolution API"]
        PG[("PostgreSQL")]
        EVOL_SVC <--> PG
    end

    %% ============ ARGUS SERVER ============
    subgraph ARGUS ["üß† Argus Server :3000"]
        direction TB

        %% --- Ingestion Pipeline ---
        subgraph INGEST ["üì• Ingestion Pipeline"]
            direction TB
            WH["Webhook Receiver\n/api/webhook/whatsapp"]
            CLASSIFY["classifyMessage()\nStrict Keyword + Noise Filter"]
            DETECT["detectAction()\nCancel / Done / Snooze / Ignore"]
            EXTRACT["extractEvents()\nGemini Extraction + Spam & Noise Filter"]
            DEDUP["findDuplicateEvent()\n48h Title Similarity Check"]
            CONF_GATE["Confidence Gate\nthreshold ‚â• 0.65"]
            CONFLICT["checkEventConflicts()\n60min Window"]
            SAVE["insertEvent() + insertTrigger()"]
        end

        %% --- AI Engine ---
        subgraph AI ["ü§ñ Gemini AI Engine"]
            direction TB
            GEMINI["Gemini 3 Flash Preview\n+ System Prompt"]
            GEN_NOTIF["generateNotificationMessage()"]
            VALIDATE["validateRelevance()\nURL ‚Üî Event Matching"]
            AI_CHAT["chatWithContext()\nNatural Language Q&A"]
        end

        %% --- Scheduler ---
        subgraph SCHED ["‚è∞ Scheduler"]
            direction TB
            TIME_CHK["checkTimeTriggers()\n24h ¬∑ 1h ¬∑ 15m intervals"]
            REM_CHK["checkDueReminders()\n30s poll"]
            SNOOZE_CHK["checkSnoozedEvents()\n30s poll"]
        end

        %% --- Data Layer ---
        subgraph DATA ["üíæ Data Layer"]
            direction LR
            SQLITE[("SQLite + FTS5")]
            DB_OPS["db.ts CRUD"]
            DB_OPS <--> SQLITE
        end

        %% --- REST API ---
        subgraph API ["üîå REST API"]
            direction TB
            EP_EVENTS["/api/events\n/api/events/:id"]
            EP_STATS["/api/stats\n/api/health"]
            EP_ACTIONS["/api/events/:id/action\ncomplete ¬∑ snooze ¬∑ ignore ¬∑ dismiss"]
            EP_CHAT["/api/chat"]
            EP_CTX["/api/context-check"]
            EP_DAY["/api/events/day/:timestamp"]
        end

        WS["üîó WebSocket /ws"]
    end

    %% ============ CHROME EXTENSION ============
    subgraph EXT ["üß© Chrome Extension ¬∑ Manifest V3"]
        direction TB

        subgraph BG ["Service Worker"]
            direction LR
            BG_JS["background.js"]
            WS_CLI["WebSocket Client"]
            BG_JS <--> WS_CLI
        end

        subgraph CS ["Content Script"]
            direction TB
            CS_JS["content.js"]
            POPUP["Dynamic Popup Manager\nDiscovery ¬∑ Reminder ¬∑ Context ¬∑ Conflict"]
            TOAST["Toast Notifications"]
            DAY_VIEW["View My Day\nColor-coded Timeline"]
        end

        subgraph SIDE ["AI Chat Sidebar"]
            direction LR
            SP_HTML["sidepanel.html"]
            SP_JS["sidepanel.js"]
        end

        subgraph EXT_POP ["Extension Popup"]
            direction LR
            POP_HTML["popup.html"]
            POP_JS["popup.js"]
        end
    end

    %% ============ 3 CORE SCENARIOS ============
    subgraph SCENARIOS ["üéØ 3 Core Scenarios"]
        direction LR
        S1["ü•ú Goa Cashew\nRecommendation ‚Üí URL trigger\non travel/goa sites"]
        S4["üì∫ Netflix Cancel\nSubscription ‚Üí URL trigger\non netflix.com"]
        S5["üìÖ Calendar Conflict\nInformal dinner commitment ‚Üí\nConflict when new meeting overlaps"]
    end

    %% ============ INGESTION FLOW ============
    WA -->|"messages"| EVOL_SVC
    EVOL_SVC -->|"webhook POST"| WH
    WH --> CLASSIFY
    CLASSIFY -->|"‚ùå noise / no signal"| SKIP_MSG["‚è≠Ô∏è Skip"]
    CLASSIFY -->|"‚úÖ has action"| DETECT
    CLASSIFY -->|"‚úÖ has event signal"| EXTRACT
    DETECT -->|"action found"| ACTION_EXEC["Execute on DB\ndelete ¬∑ complete ¬∑ snooze"]
    DETECT -->|"no action"| EXTRACT
    EXTRACT -->|"AI call"| GEMINI
    EXTRACT --> CONF_GATE
    CONF_GATE -->|"< 0.65 ‚Üí reject"| SKIP_LOW["‚è≠Ô∏è Low Confidence"]
    CONF_GATE -->|"‚â• 0.65 ‚Üí check dedup"| DEDUP
    DEDUP -->|"duplicate found ‚Üí skip"| SKIP_DUP["‚è≠Ô∏è Duplicate"]
    DEDUP -->|"unique ‚Üí save"| SAVE
    SAVE --> CONFLICT
    CONFLICT -->|"overlap detected"| WS
    SAVE --> DB_OPS

    %% ============ AI ENGINE CONNECTIONS ============
    DETECT -->|"AI call"| GEMINI
    AI_CHAT -->|"AI call"| GEMINI
    VALIDATE -->|"AI call"| GEMINI
    GEN_NOTIF -->|"AI call"| GEMINI
    VALIDATE --> DB_OPS

    %% ============ SCHEDULER ‚Üí DATA ‚Üí WS ============
    TIME_CHK --> DB_OPS
    REM_CHK --> DB_OPS
    SNOOZE_CHK --> DB_OPS
    SCHED -->|"broadcast events"| WS

    %% ============ WS ‚Üî EXTENSION ============
    WS_CLI <-->|"WebSocket :3000/ws"| WS
    WS_CLI -->|"popup data"| CS_JS
    WS_CLI -->|"notifications"| BG_JS

    %% ============ EXTENSION ‚Üí API ============
    CS_JS --> POPUP
    CS_JS --> TOAST
    CS_JS --> DAY_VIEW
    SP_JS -->|"POST /api/chat"| EP_CHAT
    POP_JS -->|"GET /api/events"| EP_EVENTS
    POP_JS -->|"GET /api/stats"| EP_STATS
    CS_JS -->|"POST /api/events/:id/action"| EP_ACTIONS

    %% ============ CONTEXT TRIGGER FLOW ============
    CHROME -->|"URL changes"| BG_JS
    BG_JS -->|"POST /api/context-check"| EP_CTX
    EP_CTX -->|"validate"| VALIDATE
    EP_CTX -->|"matching events"| BG_JS
    BG_JS -->|"context popup"| CS_JS

    %% ============ API ‚Üí DATA ============
    EP_CHAT --> AI_CHAT
    EP_ACTIONS --> DB_OPS
    EP_EVENTS --> DB_OPS
    EP_STATS --> DB_OPS
    EP_DAY --> DB_OPS
    ACTION_EXEC --> DB_OPS

    %% ============ SCENARIO TRIGGERS ============
    S1 -.->|"travel site URL match"| EP_CTX
    S4 -.->|"netflix.com URL match"| EP_CTX
    S5 -.->|"time overlap check"| CONFLICT